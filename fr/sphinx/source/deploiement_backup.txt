.. -*- coding: utf-8 -*-

.. _deploiement_backup:

=====================
Déploiement et backup
=====================

Définition
==========

Le déploiement d'un site Plone requiert des options particulières. Par exemple,
nous voulons être sûr qu'une configuration d'un buildout produit la même chose
aujourd'hui ou dans un an.

Savoir
======

- Profil buildout de déploiement
- Mettre en place un backup de la ZODB
- Apache
- Varnish
- CacheFu
- plone.app.caching

.. todo:: configuration supervisord


Profil de déploiement
=====================

.. sidebar::
   Rappel

   Vous pouvez réviser vos connaissances sur :term:`buildout` en relisant le
   chapitre :ref:`buildout_plone3`.


Créez un fichier :file:`deployment.cfg` :

.. code-block:: cfg

   [buildout]
   extends = buildout.cfg

   parts +=
        varnish-build
        varnish

    eggs +=
        Products.CacheSetup

    [varnish-build]
    recipe = zc.recipe.cmmi
    url = ${varnish:download-url}

    [varnish]
    recipe = plone.recipe.varnish
    daemon = ${buildout:parts-directory}/varnish-build/sbin/varnishd
    bind = 127.0.0.1:8000
    backends = 127.0.0.1:${instance:http-address}
    cache-size = 1G
    user = zope

Relancez le buildout avec :command:`bin/buildout -c deployment.cfg`.

Vous allez créer un utilisateur zope qui servira seulement pour le proxy cache
varnish :

.. code-block:: sh

    $ sudo adduser zope

Pour lancer varnish :

.. code-block:: sh

    $ sudo -s
    $ bin/varnish

Pour l'arrêter :

.. code-block:: sh

    $ pkill varnish


Support des backups
===================

Éditez :file:`buildout.cfg`, ajoutez ``backup`` dans parts :

.. code-block:: cfg

    parts =
        ...
        backup

et ajoutez la section ``[backup]`` comme ceci :

.. code-block:: cfg

    [backup]
    recipe = collective.recipe.backup
    keep = 15
    full = true
    gzip = true

Vous avez par défaut les options suivantes :

.. code-block:: cfg

    location = ${buildout-directory}/var/backups
    snapshotlocation = ${buildout-directory}/var/snapshotbackups

`Plus d'informations sur les options de la recipe
<http://pypi.python.org/pypi/collective.recipe.backup>`__

Pour exécuter la sauvegarde toutes les nuits, vous pouvez ajoutez un cron job
(:command:`crontab -e`), ici à 3h du matin :

.. code-block:: cfg

    00 3 * * *      /home/zope/MyProject/bin/backup -q

Vous allez voir dans la suite une configuration de buildout qui s'occupe de
créer le cron job à votre place.

Pour faire une restauration :

.. code-block:: sh

   $ bin/restore

Si vous voulez faire un backup de la production pour travailler ensuite en local, utilisez plutôt la commande :

.. code-block:: sh

    $ bin/snapshotbackup

qui créera une sauvegarde dans le dossier :file:`var/snapshotbackups/`, utile
pour ne pas perturber les sauvegardes normales qui se font la nuit.  Vous
récupérez ensuite la sauvegarde (les fichiers :file:`.fsz` et :file:`.dat`) via
:command:`scp` et vous placez la sauvegarde dans votre dossier
:file:`var/backups/` en local et exécutez :command:`bin/restore` en local.


Cron job pour zeopack et backup
===============================

Voici un exemple de configuration qui étend :file:`deployment.cfg` pour
réaliser un pack de la database avec la commande :command:`bin/zeopack` et 
faire un backup avec la commande :command:`bin/backup` vue précédemment.

Il synchronise également les dossiers :file:`backup/` et :file:`log/` sur un autre serveur.

Tout cela est réalisé par un job cron à 3h du matin.

.. centered:: :file:`serveur0.example.com`

.. code-block:: cfg

  [buildout]
  extends = deployment.cfg
  versions = versions
  parts +=
      backup-template
      backup-schedule

  [versions]
  collective.recipe.template = 1.6
  z3c.recipe.usercrontab = 1.0

  [backup-template]
  recipe = collective.recipe.template
  inline =
      #!/bin/bash
      ${buildout:bin-directory}/zeopack
      ${buildout:bin-directory}/backup -q
      rsync -a --delete ${backup:location}/ \
      save@serveur1.example.com:/home/save/MyProject/backups/
      rsync -a --delete ${buildout:directory}/var/log/ \
      save@serveur1.example.com:/home/save/MyProject/log/
  output = ${buildout:bin-directory}/backup.sh
  mode = 755

  [backup-schedule]
  recipe = z3c.recipe.usercrontab
  times = 0 3 * * *
  command = ${backup-template:output}

Dans cet exemple, la synchronisation se fait sur le serveur de secours/backup
*serveur1.example.com* avec le login *save*. Il vous faut préalablement partager
une clé publique entre ces deux serveurs pour que la commande :command:`rsync`
ne demande aucun mot de passe.

Pour utiliser cette configuration, exécutez :command:`bin/buildout -c
serveur0.example.com`.  Le cron job sera automatiquement ajouté dans le crontab
de l'utilisateur.


Configuration d'Apache
======================

Création d'un certificat autosigné :

.. code-block:: sh

   $ sudo mkdir -p /etc/apache2/ssl/
   $ sudo make-ssl-cert /usr/share/ssl-cert/ssleay.cnf \
   > /etc/apache2/ssl/server.crt

:file:`/etc/apache2/sites-available/kb` :

.. code-block:: apache

    NameVirtualHost 10.56.8.47:80

    <VirtualHost 10.56.8.47:80>
        ServerName devagile
        ServerAdmin anthony.sombris@devagile.fr
        ErrorLog /var/log/apache2/kb_error.log
        TransferLog /var/log/apache2/kb_access.log
        LogLevel warn
        RewriteEngine On
        RewriteRule ^/(.*) https://ssl.devagile/$1 [NC,R=301,L]

    </VirtualHost>

:file:`/etc/apache2/sites-available/ssl.kb` :

.. code-block:: apache

    NameVirtualHost 10.56.8.47:443

    <VirtualHost 10.56.8.47:443>
        ServerName ssl.devagile
        ServerAdmin anthony.sombris@devagile.fr
        ErrorLog /var/log/apache2/kb_error.log
        TransferLog /var/log/apache2/kb_access.log
        LogLevel warn

        SSLEngine On
        SSLCertificateFile /etc/apache2/ssl/server.crt
        #SSLCertificateKeyFile /etc/apache2/ssl/server.key

        RewriteEngine On
        RewriteRule ^/(.*) http://localhost:8000/VirtualHostBase/https/%{SERVER_NAME}:443/kb/VirtualHostRoot/$1 [L,P]

    </VirtualHost>

Activez les sites :

.. code-block:: sh

   $ a2ensite kb
   $ a2ensite ssl.kb

Activez les modules :

.. code-block:: sh

   $ a2enmod ssl
   $ a2enmod dav
   $ a2enmod proxy
   $ a2enmod proxy_http
   $ a2enmod rewrite

Éditez :file:`/etc/apache2/mods-enabled/proxy.conf` comme ceci :

.. code-block:: apache

    #Deny from all
    Allow from devagile


Activation de la compression
----------------------------

Activez le module deflate :

.. code-block:: sh

   $ a2enmod deflate

et éditez le fichier de configuration
:file:`/etc/apache2/mods-enabled/deflate.conf` :

.. code-block:: apache

   <IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css \
                          text/javascript application/x-javascript
   </IfModule>


Redémarrez Apache :

.. code-block:: sh

    $ /etc/init.d/apache2 restart

Configuration des DNS
=====================

Configurer vos DNS ou pour tester en local, éditez :file:`/etc/hosts` :

.. code-block:: text

    10.56.8.47 devagile ssl.devagile

Vous accéderez à votre site à partir de maintenant avec l'adresse
**http://devagile**.

Configuration de CacheFu (< Plone 4)
====================================

Allez avec le navigateur en tant qu'administrateur dans
:guilabel:`configuration du site`
-> :guilabel:`Cache Configuration Tool` et configurez de la manière suivante :

- Cocher Enable CacheFu
- Active Cache Policy: With Caching Proxy
- Proxy Cache Purge Configuration: Purge with VHM URLS
- Site Domains: https://ssl.devagile:443
- Proxy Cache Domains: http://127.0.0..1:8000
- Compression: Never

Installation et configuration de plone.app.caching (>= Plone 4)
===============================================================

:mod:`plone.app.caching` propose comme CacheFu une interface graphique pour gérer
les règles de cache HTTP pour Plone 4. Il est construit sur :mod:`z3c.caching`,
:mod:`plone.caching` et :mod:`plone.cachepurging`.

Installation
------------

Pour installer plone.app.caching il suffit de l'ajouter soit dans la liste
des eggs de votre buildout, soit en tant que dépendance à l'un de vos projets
dans le :file:`setup.py`.
Vous devez ensuite l'installer par la suite comme un module supplémentaire
dans le panneau de configuration de Plone via l'utilitaire d'ajout de modules.
Comme ce module dépend d'un certain nombre de modules qui ne sont pas fournis
par Plone, il est plus sûr de geler les versions dans votre buildout comme
suit :

.. code-block:: cfg

    extends =
        # ...
	http://good-py.appspot.com/release/plone.app.caching/1.0a1

Vous pouvez avoir une vue des versions disponibles ici :
http://good-py.appspot.com/release/plone.app.caching

Le panneau de configuration de la gestion de cache
--------------------------------------------------

Une fois installé vous allez trouver au niveau de la configuration de votre
site un lien pour configurer les règles de cache de votre site.

Cette interface graphique est constituée de quatre onglets :

1. *Changer la configuration* (Change settings) : pour gérer le comportement
   du cache HTTP

2. *Importer une configuration* (Import settings) : vous permet d'importer
   des politiques de cache prédéfinies

3. *Purger le proxy cache* (Purge caching proxy) : vous permet de lancer des
   purges manuelles sur les caches proxy

4. *RAM cache* : fournit des informations statistiques sur le cache en RAM
   et son éventuelle purge.

Pour aller plus loin :
http://dev.plone.org/plone/browser/plone.app.caching/trunk/README.txt

Ressources
==========

- `Varnish Guru Meditation on timeout <http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout>`_

Apache et Zope, VirtualHostMonster :

- http://plone.org/documentation/tutorial/plone-apache/vhm/
- http://plone.org/documentation/how-to/plone-with-apache
- http://www.zope.org/Documentation/Books/ZopeBook/2_6Edition/VirtualHosting.stx
- http://wiki.zope.org/zope2/ZopeAndApache
- http://doc.ubuntu-fr.org/tutoriel/securiser_apache2_avec_ssl


Exercice
========

Geler toutes les versions des eggs utilisés dans le buildout.

Ajout de la recipe collective.recipe.backup dans le buildout pour réaliser un backup régulier de la base de données.
